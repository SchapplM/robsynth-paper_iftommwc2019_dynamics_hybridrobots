% !TeX spellcheck = en_US
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%2345678901234567890123456789012345678901234567890123456789012345678901234567890
%        1         2         3         4         5         6         7         8

\documentclass{svproc}

\usepackage{float}
%\usepackage{ngerman} % TODO: Das beeinflusst die Sprache in der Vorlage. Argument für svproc finden.
\usepackage[utf8]{inputenc}
\usepackage{color, colortbl}
\usepackage{amsmath}

\newcommand{\bm}[1]{\boldsymbol{#1}}
\usepackage{amssymb}
\usepackage{todonotes}
\usepackage{graphicx}
\graphicspath{{./figures/}}

\definecolor{Gray}{gray}{0.9}
\definecolor{LightCyan}{rgb}{0.88,1,1}

\usepackage{calrsfs}
\DeclareMathAlphabet{\pazocal}{OMS}{zplm}{m}{n}
\newcommand{\body}[1]{{\mathcal{B}}_{#1}}
\newcommand{\ks}[1]{{\mathcal{F}}_{#1}}
\newcommand{\cc}[1]{{\mathcal{C}}_{#1}}
\newcommand{\ortvek}[3]{{ }_{(#1)}{\boldsymbol{r}}^{#2}_{#3}}
\renewcommand{\vec}[1]{\mbox{\boldmath{$#1$}}}
\newcommand{\tmat}[2]{{^{\mathrm{#1}}\vec{T}_{\mathrm{#2}}}}
\newcommand{\transp}[0]{{\mathrm{T}}}

% Markup package
\usepackage[deletedmarkup=xout,authormarkup=none]{changes}
\setremarkmarkup{\emph{(#1: #2)}}
\colorlet{lg}{red!80!black}
\colorlet{sp}{blue!80!black}
%\setremarkmarkup{\emph{\color{lg!70!white}\small(#1: #2)}}
\definechangesauthor[color=lg]{Lg}
\definechangesauthor[color=sp]{Sp}

% Geometrische Bezeichnungen des Mechanismus. Sind in schriftlichen Aufzeichnungen nicht konsistent. Daher wird die Benennung in diesem Paper geändert. Zur Übersichtlichkeit werden die alten Bezeichnungen als Makro verwendet.
% https://tex.stackexchange.com/a/9728
\makeatletter
\newcommand{\gdelta}{\afterassignment\gdelta@aux\count0=}
\newcommand{\gdelta@aux}{\csname gdelta\the\count0\endcsname}
\newcommand{\gdotdelta}{\afterassignment\gdotdelta@aux\count0=}
\newcommand{\gdotdelta@aux}{\csname gdotdelta\the\count0\endcsname}
\newcommand{\ggamma}{\afterassignment\ggamma@aux\count0=}
\newcommand{\ggamma@aux}{\csname ggamma\the\count0\endcsname}
\newcommand{\gbeta}{\afterassignment\gbeta@aux\count0=}
\newcommand{\gbeta@aux}{\csname gbeta\the\count0\endcsname}
\newcommand{\gl}{\afterassignment\gl@aux\count0=}
\newcommand{\gl@aux}{\csname gl\the\count0\endcsname}
\newcommand{\ghl}{\afterassignment\ghl@aux\count0=}
\newcommand{\ghl@aux}{\csname ghl\the\count0\endcsname}
\makeatother

\newif\ifneuenomenklatur
\neuenomenklaturtrue

% Neue Bezeichnungen:
\ifneuenomenklatur
    \expandafter\newcommand\csname gdelta8\endcsname{%
        \eta_{1}}
    \expandafter\newcommand\csname gdelta6\endcsname{%
        \eta_{2}}
    \expandafter\newcommand\csname gdelta16\endcsname{%
        \eta_{3}}
    \expandafter\newcommand\csname gdelta3\endcsname{%
        \eta_{4}}
    \expandafter\newcommand\csname gdelta19\endcsname{%
        \eta_{5}}
    \expandafter\newcommand\csname gdotdelta19\endcsname{%
        \dot{\eta}_{5}}
    \expandafter\newcommand\csname gdelta17\endcsname{%
        \eta_{6}}
    \expandafter\newcommand\csname gbeta1\endcsname{%
        \eta_{7}}
    \expandafter\newcommand\csname gdelta18\endcsname{%
        \eta_{8}}
    \expandafter\newcommand\csname ggamma5\endcsname{%
        \eta_{9}}
    \expandafter\newcommand\csname ggamma3\endcsname{%
        \eta_{10}}
    \expandafter\newcommand\csname gdelta7\endcsname{%
        \eta_{11}}
    \expandafter\newcommand\csname gdelta9\endcsname{%
        \eta_{12}}
    \expandafter\newcommand\csname gdelta20\endcsname{%
        \eta_{13}}
    \expandafter\newcommand\csname gl1\endcsname{%
        L_{1}}
    \expandafter\newcommand\csname gl2\endcsname{%
        L_{2}}
    \expandafter\newcommand\csname gl3\endcsname{%
        L_{3}}
    \expandafter\newcommand\csname gl4\endcsname{%
        L_{8}}
    \expandafter\newcommand\csname gl5\endcsname{%
        L_{4}}
    \expandafter\newcommand\csname gl6\endcsname{%
        L_{9}}
    \expandafter\newcommand\csname gl11\endcsname{%
        2L_{5}}
    \expandafter\newcommand\csname ghl11\endcsname{%
        L_{5}}
    \expandafter\newcommand\csname gl12\endcsname{%
        2L_{6}}
    \expandafter\newcommand\csname ghl12\endcsname{%
        L_{6}}
    \expandafter\newcommand\csname gl13\endcsname{%
        L_{15}}
    \expandafter\newcommand\csname gl14\endcsname{%
        L_{11}}
    \expandafter\newcommand\csname gl15\endcsname{%
        L_{7}}
    \expandafter\newcommand\csname gl20\endcsname{%
        L_{14}}
    \expandafter\newcommand\csname gl21\endcsname{%
        L_{12}}
    \expandafter\newcommand\csname gl22\endcsname{%
        L_{10}}
    \expandafter\newcommand\csname gl23\endcsname{%
        L_{13}}
    \expandafter\newcommand\csname gl16\endcsname{%
        L_{\mathrm{s}}}
\else
    % Original-Bezeichnungen:
    \expandafter\newcommand\csname gdelta8\endcsname{%
        \delta_{8}}
    \expandafter\newcommand\csname gdelta6\endcsname{%
        \delta_{6}}
    \expandafter\newcommand\csname gdelta16\endcsname{%
        \delta_{16}}
    \expandafter\newcommand\csname gdelta3\endcsname{%
        \delta_{3}}
    \expandafter\newcommand\csname gdelta19\endcsname{%
        \delta_{19}}
    \expandafter\newcommand\csname gdotdelta19\endcsname{%
        \dot{\delta}_{19}}
    \expandafter\newcommand\csname gdelta17\endcsname{%
        \delta_{17}}
    \expandafter\newcommand\csname gbeta1\endcsname{%
        \beta_{1}}
    \expandafter\newcommand\csname gdelta18\endcsname{%
        \delta_{18}}
    \expandafter\newcommand\csname ggamma5\endcsname{%
        \gamma_{5}}
    \expandafter\newcommand\csname ggamma3\endcsname{%
        \gamma_{3}}
    \expandafter\newcommand\csname gdelta7\endcsname{%
        \delta_{7}}
    \expandafter\newcommand\csname gdelta9\endcsname{%
        \delta_{9}}
    \expandafter\newcommand\csname gdelta20\endcsname{%
        \delta_{20}}
    \expandafter\newcommand\csname gl1\endcsname{%
        l_{1}}
    \expandafter\newcommand\csname gl2\endcsname{%
        l_{2}}
    \expandafter\newcommand\csname gl3\endcsname{%
        l_{3}}
    \expandafter\newcommand\csname gl4\endcsname{%
        l_{4}}
    \expandafter\newcommand\csname gl5\endcsname{%
        l_{5}}
    \expandafter\newcommand\csname gl6\endcsname{%
        l_{6}}
    \expandafter\newcommand\csname gl11\endcsname{%
        l_{11}}
    \expandafter\newcommand\csname ghl11\endcsname{%
        l_{11}/2}
    \expandafter\newcommand\csname gl12\endcsname{%
        l_{12}}
    \expandafter\newcommand\csname ghl12\endcsname{%
        l_{12}/2}
    \expandafter\newcommand\csname gl13\endcsname{%
        l_{13}}
    \expandafter\newcommand\csname gl14\endcsname{%
        l_{14}}
    \expandafter\newcommand\csname gl15\endcsname{%
        l_{15}}
    \expandafter\newcommand\csname gl20\endcsname{%
        l_{20}}
    \expandafter\newcommand\csname gl21\endcsname{%
        l_{21}}
    \expandafter\newcommand\csname gl22\endcsname{%
        l_{22}}
    \expandafter\newcommand\csname gl23\endcsname{%
        l_{23}}
    \expandafter\newcommand\csname gl16\endcsname{%
        l_\mathrm{F}}
\fi



\begin{document}
    
\mainmatter
%
\title{Kinematics and Dynamics Model via Explicit Direct and Trigonometric Elimination of Kinematic Constraints}
%
\titlerunning{Closed-Loop Dynamics via Trigonometric Elimination}  % abbreviated title (for running head)
%                                     also used for the TOC unless
%                                     \toctitle is used
%
\author{Moritz Schappler\inst{1} \and Torsten Lilge\inst{2} \and Sami Haddadin\inst{3}}
%
\authorrunning{Schappler et al.} % abbreviated author list (for running head)
%
%%%% list of authors for the TOC (use if author list has to be modified)
%\tocauthor{Moritz Schappler, Svenja Tappe, and Tobias Ortmaier}
%
\institute{Institute for Mechatronic Systems, Leibniz University Hannover, Germany\\
\email{moritz.schappler@imes.uni-hannover.de}
\and
Institute for Automatic Control, Leibniz University Hannover, Germany \\
\email{lilge@irt.uni-hannover.de}
\and
Chair of Robotics Science and Systems Intelligence, Technical University of Munich, Germany, \email{haddadin@tum.de}}
\maketitle              % typeset the title of the contribution


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{abstract}

The efficient implementation of kinematics and dynamics models is a key to model based control of mechatronic systems such as robots and wearable assistive devices.
This paper presents an approach for the derivation of these models in symbolic form for constrained systems based on the explicit elimination of the kinematic constraints using substitution variables with trigonometric expressions and the Lagrange equations of the second kind.
This represents an alternative solution to using the implicit form of the constraints or using the explicit elimination at comparable computational effort.
%
The method is applied to a novel exoskeleton designed for craftsmen force assistance, which consists of multiple planar closed kinematic loops and gear mechanisms.
\end{abstract}


%KEYWORDS
\begin{keywords}
dynamics, closed-loop, Lagrangian equations, substitution \\ variables, explicit form, trigonometric expressions
\end{keywords}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction and State of the Art}

Active mechatronic systems such as industrial robots, exoskeletons or prostheses can only be used to full capacity with model-based control relying on a computationally efficient model of the system, which has to run in real-time.
Systems with closed kinematic loops require a greater modeling effort due to an increased number of passive joints.
Unlike in classical robotics, exoskeleton systems can contain passive degrees of freedom (DoF) that are equalized by the user at the end-effector.
Therefore exoskeleton mechanisms usually have more DoF than classical robots with the same number of end-effector DoF.

The equations of motion of mechanical systems with kinematic constraints can in general be found with the implicit formulation of these constraints.
After a partitioning of the coordinates \cite{WehageHau1982}, the dynamics equations can be derived via the inverse of the constraints Jacobian in combination with the unconstrained dynamics \cite{NakamuraGho1989}, with Lagrange multipliers \cite{WehageHau1982,LuhZhe1985} or the Udwadia-Kalaba-equation \cite{UdwadiaKal1992}.
The former is implemented in symbolic multi body algorithms such as Robotran \cite{SaminFis2013} or openSymoro \cite{KhalilVijKhoMuk2014}.
The constraints Jacobian can be either derived from the explicit form of the constraints \cite{NakamuraGho1989}, or from the time derivative of the implicit form \cite{ParkChoPlo1999}.
%
For the computationally efficient analysis of mechanisms it is advantageous to derive the equations of motion in symbolic form \cite{SaminFis2013}.
This also facilitates or improves further steps such as grouping dynamics parameters to a minimal set  in the regressor form of the dynamics equations \cite{KhalilBen1995} or aspects such as linearisation, control and optimization \cite{ParkChoPlo1999}.

An explicit representation of the constraints often requires manual generation of the expressions and is only possible for a small set of mechanisms, e.\,g. some types of planar closed loops.
The implicit representation is available for all systems and is therefore used in the methods and tools mentioned above.
%
The direct calculation of all active and passive joint coordinates of a mechanism is only possible with the explicit form of the kinematic constraints.
If only the implicit form is available, dependant coordinates have to be determined with numeric iterative procedures \cite{ParkChoPlo1999}.

In this paper, the derivation of symbolic equations for the kinematics and dynamics is demonstrated for the example of an upper limb exoskeleton.
The structure of the dynamics equations is used for symbolic simplifications leading to improved computational efficiency.
The approach can be regarded as an alternative to existing methods with comparable performance.
It allows to verify the correctness of dynamics models derived by standard solutions by offering a different way of approaching the problem.
This may also open up new paths for researchers working in the area of kinematics and dynamics modeling. 
The contributions of the paper are

\vspace{-0.20cm}

\begin{itemize}
    \item a formalism for the derivation of dynamics models in symbolic form based on the explicit elimination of the kinematic constraints using substitution variables with trigonometric expressions and the Lagrange equations of the second kind,
    \item the presentation of a novel exoskeleton mechanism designed for supporting craftsmen when working with power tools, and
%    \item the detailed mathematical description of the kinematic modelling of the mechanisms constraints containing gears and multiple closed loops with
%    \item a focus on the implementation of these constraints in \emph{trigonometric explicit form} optimized with respect to nesting depth of expressions improving symbolic processing with computer algebra systems.
    \item a comparison of the presented approach with other known approaches for modeling mechanical structures with constraints.
\end{itemize}
\vspace{-0.25cm}
The exoskeleton mechanism can be regarded as an example to demonstrate the proposed approach of explicit trigonometric elimination of kinematic constraints.
Unlike industrial robots with closed loops which contain only lower kinematic pairs (i.\,e., single-DoF joints), the exoskeleton also comes with higher kinematic pars (i.\,e., contacts along a curve generated by gears).

Therefore, the paper is organized as follows:
In Sec.\,\ref{sec:exo_scenario} the components of the considered exoskeleton are briefly presented together with the envisioned scenario of its field of application. In Sec.\,\ref{sec:model} the kinematics and dynamics modelling is shown in detail, focussing on the formulation of the explicit constraint equations with substitution variables based on trigonometric expressions.
Section \ref{sec:simulation} provides a comparison of the efficiency of the different methods to calculate the inverse dynamics. Sec.\,\ref{sec:conclusion} concludes the paper.

\section{Exoskeleton Case Study}
\label{sec:exo_scenario}

The exoskeleton presented in this paper is targeted as an assistive device for craftsmen working with power tools like a hand-held power drill.
It consists of the following parts, which are depicted in Fig.\,\ref{fig:KAS5_CAD}.

\begin{figure}[b!]
    \vspace{-0.3cm}
    \input{./figures/KAS5_Seitenansicht_mit_Ellenbogen_beschriftet.pdf_tex}
    \vspace{-0.3cm}
    \caption{CAD model of the complete exoskeleton mechanism to be carried in a right-hand configuration. The right part shows a transparent detail of the elbow joint.
    \copyright\,by~Michael Winkler and BMBF project consortium ``Third Arm'' \cite{NuelleSchTapLil2017}.}
    \label{fig:KAS5_CAD}
\end{figure} 

\emph{Main Structure}:
%
With the required attachment at the user's upper body and at the hand together with the requirement of neither blocking the users workspace nor sight, the main structure of the exoskeleton shows similar DoF as the human arm.

\emph{Three-Axis Elbow Joint}:
The elbow joint of the mechanism is aligned to the axis of rotation of the user's elbow.
To reduce associated constraint forces, the joint consists of three parallel axes, which couple the upper arm and the forearm via a central gear wheel.
The mechanism is shown in detail in the right part of Fig.\,\ref{fig:KAS5_CAD}.
The lever mechanism connecting the linear spring-damper-system with the elbow is fixed to the central elbow gear.

\emph{Three-Axes Shoulder Joint:}
The shoulder joint imitates the degrees of freedom of a simplified model of the human shoulder with three consecutive rotations with perpendicular axes.
The last axis of the shoulder joint corresponding to the shoulder flexion/extension (F/E) is parallel to the axes of the elbow and the coupling mechanism, leaving the greatest part of the joints in one plane to simplify manufacturing and kinematics modeling.

\emph{Coupling Mechanism Shoulder-Elbow:}
The shoulder F/E joint and the elbow joint are coupled via a mechanism consisting of two crank-lever mechanisms.
This removes one DoF from the system and forces the shoulder and first elbow rotation to move on a common trajectory.
With this mechanical coupling it is possible to transfer forces from the shoulder to the elbow and therefore relocate a motor actuating the elbow to the shoulder.
This concept is known from industrial robots with a parallelogram structure connecting the second and third joint relocating the motor close to the second joint, reducing the inertia and gravitational load of the system \cite{LuhZhe1985}.

\emph{Spring-Damper System:}
The elbow joint is connected via the central gear and a linear spring damper system with the forearm.
The spring is transferring the moment created by the weight of the powertool towards the central gear and reduces oscillations originating from largely disturbing processes like drilling.

\section{Kinematics and Dynamics Modelling}
\label{sec:model}

In the following, the single steps to gain dynamics equations required for control and simulation purposes are laid out at the example of the exoskeleton system introduced in the previous Sec.\,\ref{sec:exo_scenario}.
% are summarized in Fig.\,\ref{fig:flowchart_overview} and
The required steps include the creation of the general kinematic model and coordinate definitions in Sec.\,\ref{sec:model_fullcoord} and the elimination of supernumerous coordinates in Sec.\,\ref{sec:model_elim}.
These steps allow to derive the dynamics equations as shown in Sec.\,\ref{sec:Lagrange2Elim}.
The standard coordinate partitioning method is presented in Sec.\,\ref{sec:DynamicsImpl} for comparison.

\subsection{Kinematic Model and Coordinate Definition}
\label{sec:model_fullcoord}

All rotational axes of the mechanism are described as single-DoF joints using the modified Denavit-Hartenberg notation \cite{KhalilBen1995} to describe the position and orientation of the frames $\ks{i}$ attached to all rigid bodies $\body{i}$ of the mechanism.
The parameters describing the transformations between these frames are given in the left part of Fig.\,\ref{fig:KAS5_kinematik} next to a kinematic sketch of the mechanism in the right part of Fig.\,\ref{fig:KAS5_kinematik} with annotations for frames, bodies and coordinates to improve the confirmability of the table.

%
\begin{figure}[htb]
\fontsize{8}{12}\selectfont
\begin{tabular}[t]{l r}
    \begin{tabular}[t]{|c|c|c|c|c|c|c|c|c|c|c|}
        \hline
        $i$ & $a$ & $\mu_i$ & $\sigma_i$ & $\gamma_i$ & $\epsilon_i$ & $\alpha_i$ & $d_i$ & $\theta_i$ & $r_i$ & $O_i$\\
        \hline
          &  &   &   & $\bm{R}_{\mathrm{}z}$ & $\bm{T}_{\mathrm{z}}$  & $\bm{R}_{\mathrm{}x}$  & $\bm{T}_{\mathrm{}x}$  &   $\bm{R}_{\mathrm{}z}$ & $ \bm{T}_{\mathrm{z}}$ &  \\
        \hline
        1 & 0 & $1$ & $0$ & $0$ & $0$ & $0$ & $0$ & $\rho_1-\frac{\pi}{2}$ & $\gl1$ & $O_1$ \\
        2 & 1 & $1$ & $0$ & $0$ & $0$ & $-\frac{\pi}{2}$ & $0$ & $\rho_2+\frac{\pi}{2}$ & $\gl2$ & $O_2$ \\
        3 & 2 & $0$ & $0$ & $0$ & $0$ & $\frac{\pi}{2}$ & $0$ & $\rho_3$ & $\gl3$ & $O_2$ \\
        4 & 3 & $1$ & $0$ & $0$ & $0$ & $0$ & $\gl5$ & $\rho_4$ & $0$ & $O_4$ \\
        5 & 4 & $1$ & $0$ & $0$ & $0$ & $0$ & $\gl11$ & $\rho_5$ & $0$ & $O_5$ \\
        6 & 5 & $0$ & $0$ & $0$ & $0$ & $0$ & $\gl12$ & $\rho_6 + \frac{\pi}{2}$ & $0$ & $O_6$ \\
        7 & 6 & $1$ & $0$ & $0$ & $0$ & $\frac{\pi}{2}$ & $0$ & $\rho_7$ & $\gl15$ & $O_7$ \\
        8 & 2 & $0$ & $2$ & $0$ & $0$ & $\frac{\pi}{2}$ & $0$ & $\gdelta8+\frac{\pi}{2}$ & $\gl3$ & $O_2$ \\
        9 & 8 & $0$ & $0$ & $0$ & $0$ & $0$ & $-\gl4$ & $-\gdelta6$ & $0$ & $F$ \\
        10 & 3 & $0$ & $0$ & $0$ & $0$ & $0$ & $\gl6$ & $-\gdelta16$ & $0$ & $D$ \\
        11 & 10 & $0$ & $0$ & $0$ & $0$ & $0$ & $\gl22$ & $\pi-\gdelta3$ & $0$ & $C$ \\
        12 & 4 & $0$ & $0$ & $0$ & $0$ & $0$ & $\gl11$ & $\gdelta19-\frac{\pi}{2}$ & $0$ & $O_5$ \\
        13 & 12 & $0$ & $2$ & $0$ & $0$ & $0$ & $0$ & $\gdelta17-\frac{\pi}{2}$ & $0$ & $O_5$ \\
        14 & 13 & $0$ & $0$ & $0$ & $0$ & $0$ & $\gl14$ & $3\frac{\pi}{2}-\gbeta1$ & $0$ & $B$ \\
        15 & 14 & $0$ & $1$ & $0$ & $0$ & $\frac{\pi}{2}$ & $0$ & $0$ & $\gl16$ & $A$ \\
        \rowcolor{LightCyan}
        16 & 10 & $0$ & $0$ & $\gdelta9$ & $0$ & $0$ & $\gl21$ & $*$ & $0$ & $E$ \\
        \rowcolor{LightCyan}
        17 & 13 & $0$ & $0$ & $0$ & $0$ & $0$ & $\gl14$ & $*$ & $0$ & $B$ \\
        \rowcolor{LightCyan}
        18 & 6 & $0$ & $0$ & $-\gdelta20'$ & $0$ & $0$ & $\gl23$ & $*$ & $0$ & $A$ \\
        \rowcolor{Gray}
        19 & 9 & $0$ & $2$ & $0$ & $0$ & $0$ & $\gl20$ & $0$ & $0$ & $E$ \\
        \rowcolor{Gray}
        20 & 11 & $0$ & $2$ & $0$ & $0$ & $0$ & $\gl13$ & $0$ & $0$ & $B$ \\
        \rowcolor{Gray}
        21 & 15 & $0$ & $2$ & $-\frac{\pi}{2}$ & $0$ & $0$ & $0$ & $0$ & $0$ & $A$ \\
        \hline
    \end{tabular}
	\begin{minipage}[t]{7.5cm}
        \tiny
        \vspace{0.001cm} % wird für bounding box des Bilds benötigt
        \scalebox{1.1}{\input{./figures/KAS5_m3_skizze_kinematik_2_KS_mod.pdf_tex}}
    \end{minipage}
\end{tabular}
	\caption{Left: Table with the kinematic parameters of the considered structure. Right: Kinematic sketch of the mechanism with frames according to the table. Body numbers are indicated with circles. Bottom: Definitions of geometric parameters and coordinates.}
    \label{fig:KAS5_kinematik}
\end{figure}
%

Due to the structure of the mechanism, the extended notation with anteceding link index $a(i)$, joint type marker $\sigma_i$ (0 for rotational joint, 1 for prismatic joint, 2 for fixed connection) and actuation marker $\mu_i$ (0 for passive, 1 for active joint) is used.
The marker $\mu_i$ is set to 1 for the joints representing the generalized coordinates, regardless whether they are actuated or not.
The order of rotations $\bm{R}$ and translations $\bm{T}$ is given in the head row for $\gamma_i$ to $r_i$.
Only rows 1 to 15 of the table mark frames associated with rigid bodies.
Rows 16-18 denote the first frame and rows 19-21 the second frame of the cut joints belonging to the three closed kinematic loops.
The coordinate of the cut joint frames 16-18 are marked with a ``$*$'' and are not regarded further, since they are not needed for the dynamics.
Additionally, the origins $O_i$ of the coordinate systems are given in Fig.\,\ref{fig:KAS5_kinematik} for a better overview.

The mechanism is considered without the kinematic constraints by virtually cutting the loop-closing joints resulting in a tree structure \cite{KhalilBen1995} and removing the other constraints that are referred to as ``user constraints'' in \cite{SaminFis2013}.
According to \cite{NakamuraGho1989}, the coordinates 
%
$
\bm{q}=\begin{pmatrix}\bm{q}_{1}^\transp & \bm{q}_{2}^\transp \end{pmatrix}^\transp
$
%
of the single-DoF joints of this unconstrained system can  be separated into the generalized coordinates
%
$\bm{q}_1$
%
and the dependent coordinates
%
$\bm{q}_{2}$.
%
The constant kinematics parameters can be grouped into a separate vector
%
$\bm{p}_{\mathrm{kin}}$.
%
Hereby the joint coordinates of the main structure are denoted with $\rho$, the coordinates and constant angles of the parallel coupling and support mechanism with $\eta$ and the variable elongation of the spring with $\gl16$.

Without loss of generality, the coordinates $\rho$ and $\eta$ can be grouped according to the joint type into rotational coordinates $\bm{q}_{\mathrm{R}}$ corresponding to $\sigma_i=0$ and translational coordinates $\bm{q}_{\mathrm{T}}$ corresponding to $\sigma_i=1$ with
%
\begin{equation}
\bm{q}_1=\begin{pmatrix}\bm{q}_{1\mathrm{R}}^\transp & \bm{q}_{1\mathrm{T}}^\transp \end{pmatrix}^\transp,
\bm{q}_2=\begin{pmatrix}\bm{q}_{2\mathrm{R}}^\transp & \bm{q}_{2\mathrm{T}}^\transp \end{pmatrix}^\transp.
\label{equ:q12_sep_transl_rot}
\end{equation}
%
In the following, the dependent coordinates are expressed in the explicit form
%
\begin{equation}
\bm{q}_2 = \bm{f}(\bm{q}_1) \label{equ:kinconstr_explicit},
\quad \bm{q}_{2\mathrm{R}} = \bm{f}_{\mathrm{R}}(\bm{q}_1), 
\quad \bm{q}_{2\mathrm{T}} = \bm{f}_{\mathrm{T}}(\bm{q}_1)
\end{equation}
%
as a function of the generalized coordinates $\bm{q}_1$.
This will be used to determine the configuration $\bm{q}$ of the complete system depending on the pose of the main structure and to generate dynamics equations for simulation and model based controllers.

\subsection{Elimination of Kinematic Constraints}
\label{sec:model_elim}


\begin{figure}[tb]
    \begin{center}
        {\input{./figures/KAS5_parallelmech_detail.pdf_tex}}
    \end{center}
    \caption{Kinematic sketch of (a) the lower part and (b) the upper part of the mechanism with annotations for circles, angles and frames. Missing $z$-axes point out of the paper.}
    \label{fig:KAS5_detail}
\end{figure}


The kinematic constraints of the system originate from the rolling condition of the elbow gears and the closed loop constraints in the coupling mechanism.
%
The expressions for the different dependent coordinates in $\bm{q}_{2}$ can be calculated by intersecting circles resulting from the planar motion of the single parts of the four-bar-linkages.
Calculating $\{C, C^\prime\} = \cc{1} \cap \cc{2}$ for the elbow-shoulder-coupling from Fig.\,\ref{fig:KAS5_detail}\,(a) gives equations for the dependant coordinates $\gdelta16$ and  $\gdelta3$.
The intersection $\{F, F^\prime\} = \cc{3} \cap \cc{4}$ of the second set of circles in Fig.\,\ref{fig:KAS5_detail}\,(b) give $\rho_3$ and $\gdelta6$.
The variables $\gdelta19$ and $\rho_6$ can be solved by equating the velocities of the pitch point of the two gear contacts from both sides.
Solving the slider-crank mechanism of the forearm finally gives $\gbeta1$ and $\gl16$.
%
This provides the explicit definitions of the kinematic constraints defined in (\ref{equ:kinconstr_explicit}), which are needed for the complete kinematic description of the frames and rigid bodies defined in Fig.\,\ref{fig:KAS5_kinematik}.

It shall be emphasized that the explicit form of the rotatory coordinates $\bm{q}_{2\mathrm{R}}$ can be calculated using (\ref{equ:kinconstr_explicit}).
However also a specific implicit form can be defined with the angles as an argument of the sine and cosine functions with
%
\begin{equation}
\mathrm{sin}(\bm{q}_{2\mathrm{R}}) = \bm{f}_{\mathrm{R}\mathrm{sin}}(\bm{q}_1),
\quad
\mathrm{cos}(\bm{q}_{2\mathrm{R}}) = \bm{f}_{\mathrm{R}\mathrm{cos}}(\bm{q}_1). \label{equ:kinconstr_semiexplicit_sincos}
\end{equation}
%
The translatory coordinates $\bm{q}_{2\mathrm{T}}$ and velocities can still be used in the explicit form
%
\vspace{-0.2cm}
\begin{equation}
\bm{q}_{2\mathrm{T}} = \bm{f}_{\mathrm{T}}(\bm{q}_{1}), 
\quad 
\dot{\bm{q}}_{2} = \bm{f}_{\mathrm{diff}}(\bm{q}_{1},\dot{\bm{q}}_{1}). \label{equ:kinconstr_semiexplicit_diff_transl}
\end{equation}
%
The specific implicit form of (\ref{equ:kinconstr_semiexplicit_sincos}) allows to produce simpler symbolic expressions when solving the set of equations for the unknown joint variables $\bm{q}_{2}$. 
This is facilitated by the use of the angle sum identities.
The form  (\ref{equ:kinconstr_semiexplicit_sincos}) is called \emph{trigonometric explicit form} in this paper since trigonometric functions are used as substitution variables and the form is explicit in these variables.
The expressions of this form have a tendency to additions and products of sine and cosine terms.
The explicit form (\ref{equ:kinconstr_explicit}) on the contrary contains nested expressions with arctangent functions, since every successive substitution of the angles in the calculation of the closed loops results in a new nested term of the arctangent function in the expression.
The latter has shown to be inefficient without further optimizations for processing with Maple, a computer algebra system that was used to create the symbolic expressions and to generate code for dynamics functions. % TODO: Noch näher auf die Art der Optimierung eingehen? (Reihenfolge der Substitution, Nutzung der Rotation um die gleiche Achse.)

\subsection{Dynamics Model using Explicit Constraints}
\label{sec:Lagrange2Elim}

The dynamics equations are derived in this work using Lagrange equations of the second kind. This method needs the Lagrangian 
%
\begin{align}
L(\bm{q},\dot{\bm{q}}) = T(\bm{q},\dot{\bm{q}})-(U_{\mathrm{g}}(\bm{q})+U_{\mathrm{s}}(\bm{q}))
\label{equ:Lagrange_energy}
\end{align}
%
expressed in minimal coordinates $\bm{q}_{1}$.
Rotation matrices from all the frame transformations from Fig.\,\ref{fig:KAS5_kinematik} are used to calculate the kinetic energy $T$ as well as the potential energies $U_{\mathrm{g}}$ from gravity and $U_{\mathrm{s}}$ from the spring.
Separating the rotational and translational coordinates as introduced in (\ref{equ:q12_sep_transl_rot}) yields the Lagrangian from (\ref{equ:Lagrange_energy}) in the structure
%
\begin{align}
L(\bm{q},\dot{\bm{q}}) =L( & \mathrm{sin}  (\bm{q}_{\mathrm{R}}),\mathrm{cos}(\bm{q}_{\mathrm{R}}), \bm{q}_{\mathrm{T}},\dot{\bm{q}}) \\\label{eq:lagrange_nonmin}
=L( & \mathrm{sin}  (\bm{q}_{1\mathrm{R}}),\mathrm{cos}(\bm{q}_{1\mathrm{R}}), \bm{q}_{1\mathrm{T}},\dot{\bm{q}}_{1}, \mathrm{sin}  (\bm{q}_{2\mathrm{R}}),\mathrm{cos}(\bm{q}_{2\mathrm{R}}), \bm{q}_{2\mathrm{T}},\dot{\bm{q}}_{2}).
\end{align}
%
After substitution of (\ref{equ:kinconstr_semiexplicit_sincos}) and (\ref{equ:kinconstr_semiexplicit_diff_transl}) into (\ref{eq:lagrange_nonmin}), the Lagrangian 
%
\begin{align}
L(\bm{q}_1,\dot{\bm{q}}_1)=L( & \mathrm{sin} (\bm{q}_{1\mathrm{R}}),\mathrm{cos}(\bm{q}_{1\mathrm{R}}), \bm{q}_{1\mathrm{T}},\dot{\bm{q}}_{1}, \\ &
\bm{f}_{\mathrm{R}\mathrm{sin}}(\bm{q}_1),
\bm{f}_{\mathrm{R}\mathrm{cos}}(\bm{q}_1),
\bm{f}_{\mathrm{T}}(\bm{q}_1),
\bm{f}_{\mathrm{diff}}(\bm{q}_1,\dot{\bm{q}}_1))) \nonumber
\end{align}
%
is represented in the minimal coordinates $\bm{q}_1$.
This allows using the Lagrange equations
%
\begin{equation}
\frac{\mathrm{d}}{{\mathrm{d}}t}\frac{\partial L(\bm{q}_1,\dot{\bm{q}}_1)}{\partial \dot{\bm{q}}_1} - \frac{\partial L(\bm{q}_1,\dot{\bm{q}}_1)}{\partial \bm{q}_1}= \bm{\tau}^c_1,
\end{equation}
%
to get the inverse dynamics joint torques\footnote{joint forces in the case of prismatic joints are also referred to as torques for the sake of readability} $\bm{\tau}^c_1$ of the constrained system in coordinates $\bm{q}_1$, which allows to obtain the dynamics equations in explicit form
%
\begin{equation}
\bm{M}_1\ddot{\bm{q}}_1+\bm{c}_1(\bm{q}_1,\dot{\bm{q}}_1)+\bm{g}_1(\bm{q}_1) + \bm{\tau}_{1\mathrm{s}}(\bm{q}_1) = \bm{\tau}^c_1,
\label{equ:Dyn_MinKoord}
\end{equation}
%
where $\bm{M}_1$, $\bm{c}_1$, $\bm{g}_1$, $\bm{\tau}_{1\mathrm{s}}$ denote the inertia matrix, and the vectors of centrifugal/Coriolis torques, gravity torques and spring torques, respectively.
%der auch in \cite{NakamuraGho1989} zur Herleitung von (\ref{equ:tau_Projektion}) benutzt wurde, folgt wieder die gesuchte Dynamik-Darstellung aus (\ref{equ:Dyn_MinKoord}).

%
%Für Newton-Euler bräuchte man noch $d^2(x)/dt^2=...$.
%Diese Formen sind effizienter zu berechnen als die explizite Form $x=...$ (auf die dann wieder $sin()$, $cos()$ angewendet würde).
%Das wurde in \cite{WangGosselin1998} schon so gemacht. Dort aber nicht wirklich hervorgehoben.


\subsection{Dynamics Model using Implicit Constraints}
\label{sec:DynamicsImpl}

For comparison of the computational efficiency of the approach proposed in the previous section, the standard method \cite{NakamuraGho1989,ParkChoPlo1999,KhalilBen1995,SaminFis2013} of using kinematic constraints in implicit form is briefly summarized.

The presented exoskeleton contains three kinematic loops which are cut in the joints corresponding to the rows 16, 17 and 18 of Fig.\,\ref{fig:KAS5_kinematik} (points $E$, $B$ and $A$).
These joints do not articulate any bodies and are associated with a second virtual frame in the entries 19, 20 and 21 of Fig.\,\ref{fig:KAS5_kinematik} that are fixed to the other link of the respective cut joint \cite{KhalilBen1995,SaminFis2013}.
For the given mechanism, three vector loops can be defined with the homogeneous transformation matrices
%
\begin{align}
\tmat{3}{4} \tmat{4}{12} \tmat{12}{13} \tmat{13}{17} &= \tmat{3}{10} \tmat{10}{11} \tmat{11}{20} \label{equ:implconstr_chain1} \\
\tmat{2}{3} \tmat{3}{10} \tmat{10}{16}  &= \tmat{2}{8} \tmat{8}{9} \tmat{9}{19} \label{equ:implconstr_chain2} \\
\tmat{4}{5} \tmat{5}{6} \tmat{6}{18}  &= \tmat{4}{12} \tmat{12}{14} \tmat{14}{15} \tmat{15}{21}.
\label{equ:implconstr_chain3}
\end{align}
%
Each of these equations provides two linearly independent entries in the translational part of the transformation matrix.
Therefore it is not required to take the angle of the cut joint into consideration.
Together with the gear constraints the eight implicit constraints can be written as
%
$
\bm{h}(\bm{q}_1, \bm{q}_2) = \bm{0}
$
%
with the partial derivatives
%
\vspace{-0.3cm}
\begin{align}
\bm{J}_1(\bm{q}_1, \bm{q}_2)=\frac{\partial\bm{h}}{\partial \bm{q}_1}, \quad 
\bm{J}_2(\bm{q}_1, \bm{q}_2)=\frac{\partial\bm{h}}{\partial \bm{q}_2}. \label{equ:kinconstr_impl_grad}
\end{align}
%
The projection matrix $\bm{W}$ from \cite{NakamuraGho1989,ParkChoPlo1999} is used in the form
\vspace{-0.3cm}
%
\begin{equation}
\bm{W} = \frac{\partial \bm{q}}{\partial \bm{q}_1} 
= \begin{pmatrix} \bm{E}\\ \frac{\partial \bm{q}_2}{\partial \bm{q}_1} \end{pmatrix}
= \begin{pmatrix} \bm{E}\\ -\bm{J}_2^{-1}\bm{J}_1 \end{pmatrix}
\label{equ:kinconstr_impl_projmatrix}
\end{equation}
%
in order to obtain the joint torques $\bm{\tau}^c_1$ of the constrained system in minimal coordinates $\bm{q}_1$ as
%
\begin{equation}
\bm{\tau}^{c}_{1} = \bm{W}^\transp \bm{\tau}.
\label{equ:tau_projection}
\end{equation}
%
The matrix from (\ref{equ:kinconstr_impl_projmatrix}) still contains the dependent joint coordinates $\bm{q}_2$ which have to be calculated numerically with iterative methods using the Jacobians from (\ref{equ:kinconstr_impl_grad}) or with the explicit form (\ref{equ:kinconstr_explicit}).
The advantage of this method is the availability of efficient tools to symbolically compute the inverse dynamics $\bm{\tau}$ of the unconstrained system.
Further, for most systems the passive joint constraint Jacobian $\bm{J}_2$ is sparse and can be efficiently inverted symbolically \cite{ParkChoPlo1999}.

\section{Computational Costs of the proposed Methods}
\label{sec:simulation}

The inverse dynamics (\ref{equ:Dyn_MinKoord}) of the constrained system was derived using the different approaches presented in this paper.
The computational efforts to compute the terms $\bm{g}_1$ and $\bm{M}_1$ are compared in Tab.\,\ref{tab:computation}.
The used methods are 
%
\begin{enumerate}
    \item \emph{Trigonometric elimination} (``TE'') of the constraints by substituting with (\ref{equ:kinconstr_semiexplicit_sincos}) as described in Sec.\,\ref{sec:Lagrange2Elim}, 
    \item \emph{Direct elimination} (``DE'') of the constraints by directly using (\ref{equ:kinconstr_explicit}) to substitute the dependent joint coordinates in (\ref{equ:Lagrange_energy}),
    \item using \emph{implicit constraint equations} (``IC'') as described in Sec.\,\ref{sec:DynamicsImpl}.
\end{enumerate}
%
The expressions are generated with Maple using the procedure \texttt{optimize} with \texttt{tryhard} and the number of operations is counted with the procedure \texttt{cost}.
%
\begin{table}[tb]
    \caption{Comparison of the computational effort for different implementations of the gravitational load $\bm{g}_1(\bm{q}_1)$ and the mass matrix $\bm{M}_1(\bm{q}_1)$ .}
    \label{tab:computation}
    \centering
    \setlength\tabcolsep{3pt}
    \small
    \begin{tabular}[t]{|c|c|c|c|c|c|c|c|c|c|} 
        \hline
         & $\pm$ & $*$ & $/$ & $\sqrt{}$ & $\mathrm{sin}$ & $\mathrm{atan}$ & $:=$ & Sum & $t_{\mathrm{Gen}}$ \\
        Factor & 1 & 1 & 4 & 5 & 10 & 15 & 1 & (weighted) & \\
        \hline
        Method & \multicolumn{8}{c}{gravitational load $\bm{g}_1(\bm{q}_1)$} &  \\
        \hline
        \rowcolor{Gray}
        1: TE  & 710 & 985 & 12 & 3 & 22 & 0 & 365 & \textbf{2343} & 1.4\,h \\
        \rowcolor{Gray}
        2: DE & 491 & 646 & 24 & 3 & 38 & 5 & 358 & \textbf{1975} & 0.4\,h \\
        \rowcolor{Gray}
        3: IC & 462 & 554 & 6 & 0 & 50 & 0 & 264 & \textbf{1804} & 2\,s \\
        $\bm{W}$ & 40 & 66 & 6 & 0 & 22 & 0 & 36 & 386 & 1\,s \\
        $\bm{g}$ & 422 & 488 & 0 & 0 & 28 & 0 & 228 & 1418 & 1\,s \\
        \hline
        Method & \multicolumn{8}{c}{mass matrix $\bm{M}_1(\bm{q}_1)$} & \\
        \hline
        \rowcolor{Gray}
        1: TE  & 1138 & 1671 & 28 & 3 & 22 & 0 & 598 & \textbf{3754} & 2.0\,h \\
        \rowcolor{Gray}
        2: DE & 1142 & 1656 & 25 & 3 & 32 & 5 & 591 & \textbf{3899} & 2.0\,h \\
        \rowcolor{Gray}
        3: IC & 1230 & 1730 & 6 & 0 & 48 & 0 & 537 & \textbf{4001} & 17\,s \\
        $\bm{W}$ & 40 & 66 & 6 & 0 & 22 & 0 & 36 & 386 & 1\,s \\
        $\bm{M}$ & 1190 & 1664 & 0 & 0 & 26 & 0 & 501 & 3615 & 16\,s \\
        \hline
    \end{tabular}
    \vspace{-0.5cm}
\end{table}
%

To give an estimate of the computational cost, the different operations are counted in a weighted sum. An estimation of the lower bound for the cost factor of the floating point  operation types relative to simple additions is adapted from \cite{Atkinson2014}, \cite{Hindriksen2012} and given in the second row in Tab.\,\ref{tab:computation}.
The exact time for computation depends on the concrete hard- and software and further optimizations of the implementation.

Since the inverse dynamics of the open loop tree structure can be calculated very efficiently and the sparsity of the projection matrix $\bm{W}$ is high, benefiting the symbolic inversion, the standard method 3 has an appr. 10\,\% lower computational effort compared to method 2 for the gravitational load as shown in the upper part of Tab.\,\ref{tab:computation}.
Method 2 outperforms method 1 when using an optimized order of symbolic substitutions.
%The methods 1 and 2 based on elimination perform similar w.r.t. the operation count.
%The time $t_{\mathrm{Gen}}$ needed to optimize and generate the code is about 25\,\% lower for the proposed method 1, indicating that the computer algebra system does not perform well for the kind of expressions produced in method 2.
The time $t_{\mathrm{Gen}}$ needed to optimize and generate the code is several orders of magnitude slower than the time for method 3.

As summarized in the lower part of Tab.\,\ref{tab:computation}, the elimination methods 1 and 2 perform slightly better than the standard method 3 for the inertia matrix.
This can be explained by the high number of DoF for the 15\,$\times$\,15 matrix $\bm{M}$ from method 3 compared to a smaller 5\,$\times$\,5 matrix $\bm{M}_1$ for methods 1 and 2.
%Using method 1 needs more multiplications and additions probably due to the products in the angle sum identities.

\section{Conclusions and future work}
\label{sec:conclusion}

%conclusion:
This paper presented a novel concept for a force assistance exoskeleton to support workers in carrying and using powertools and its dynamics modeling.
The details of the solution of the kinematic constraints of the multi-loop mechanism focus on the elimination of trigonometric expressions of dependent variables.
This reduces the computational load when creating symbolic code for the terms of the dynamics equation with a similar efficiency of the output.
However, the presented approach does not completely reach the computational performance of standard solutions for the given mechanism.
On the upside it can be used to test the correctness of dynamics models with the standard solution by offering a different way of approaching the problem.
This may also give new ideas to researchers working in the area of kinematics and dynamics modeling.

%Future work:
In future works, the featured approach of implementing kinematic constraints will be applied to different serial-chain industrial robots with parallel mechanisms invoking kinematic constraints, i.\,e. hybrid robots. 
The results will be compared to the classical approach using the projection of constraint forces and with non-trigonometric elimination of the constraints.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section*{APPENDIX}
%
%Appendixes should appear before the acknowledgment.


\section*{Acknowledgements}

The financial support from the Federal Ministry of Education and Research
of Germany (BMBF) under grant number 16SV6175 is gracefully acknowledged.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% BIBLIOGRAPHY
\bibliographystyle{spmpsci_unsrt}
\bibliography{ref}
\end{document}
\grid
